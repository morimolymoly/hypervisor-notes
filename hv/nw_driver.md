# ネットワークドライバ概要
ハイパーバイザでのネットワークドライバの実装等をまとめる

## ネットワークドライバのいろは
### レジスタとかLinuxカーネルでのあつかい
ネットワークドライバはハードウェアを初期化して，システムコールに応じてコールバック関数を提供する(インターフェースはLinuxだとhogehogeで定義)  
ドライバはMMIO領域とDMA領域をもっている．ディスクリプタリングやそれを実現するためのレジスタ等はMMIOマッピングされた物理メモリ領域に存在する．アドレスはバスアドレスになっているが，x86だとバスアドレスと物理アドレスは同等である．

### わりこみとか
NICはパケットを受信したらデータをDMAしてから，受信時に割り込みを発生させる.
ネットワークドライバはそれを検知してリングバッファをみにいく．
んで受信処理をおこなう．(kbufとかにリングバッファの受信バッファをみにいく(これはNICによりDMAされてるよ！！))  
送信時はkbufにつつまれたパケットをカーネルがリングバッファのバッファにコピーして，リングバッファのレジスタ(THDとか)を更新してから，割り込みをかける．その後，NICがDMAしてリングバッファからデータをNIC側にコピーして送信する．  
そういやこの送受信の割り込みをすべてトラップするのはパフォーマンス上ネックになる．この送受信の割り込みはIDTにより管理されているのは周知の事実であるが，これをPCI Configuration SpaceのBARの使っていない領域にshadowingさせてトラップするELIとか有名ね．ベアメタルの97%の速度を叩き出してた．(すごい)

## Descriptor shadowing
ディスクリプタをshadowingすることによってハイパーバイザがゲストのパケットの送受信を管理することができる．送信時はゲストがTDT(MMIOレジスタ)を更新したときにEPT Violationを起こしてトラップ，受信時はゲストが割り込み確認のときにMMIOレジスタをみにいったときにEPT Violationしてトラップ．NICはゲストのではなくshadowingされたディスクリプタをみることになる．

## ゲストにみせるか専有するか，それともvirtioか？
ゲストに見せる場合は初期化とかをゲストに任せることができてハイパーバイザは楽ができる．virtioや専有はハイパーバイザが初期化を含むドライバを開発する必要があってだるい．
